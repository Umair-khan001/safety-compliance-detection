<!doctype html>
<html lang="en">

<head>
  <title>Safety Compliance Detection System</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <!-- Chart.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    function outputUpdate(conf_slide) {
      Number(document.querySelector('#selected-conf').value) = conf_slide.toFixed(2);
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap');

    /* Custom Header Styling (fixed) */
    .custom-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #0a0f1d 0%, #161c2d 100%);
      color: #ffffff;
      padding: 6px 30px;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      min-height: 50px;
      z-index: 1100;
    }
    .header-logo {
      font-size: 32px;
      color: #f1c40f;
      margin-right: 12px;
      margin-left: 38px;
    }
    .header-text {
      display: flex;
      flex-direction: column;
      justify-content: center;
      margin-top: 6px;
    }
    .header-text h1 {
      font-size: 12px;
      font-weight: 600;
      margin: 0;
    }
    .header-text p {
      font-size: 7px;
      font-weight: 300;
      color: #f1c40f;
      margin: 0;
    }

    /* Adjust main content top margin to account for fixed header */
    .main-content {
      margin-top: 70px;
    }
  </style>

  <style>
    @import url('http://fonts.cdnfonts.com/css/sf-pro-display');
  </style>

  <!-- Preserve original file upload button and slider styles -->
  <style>
    input::file-selector-button {
      font-weight: bold;
      color: white;
      background-color: black;
      padding: 0.5em;
      border: thin solid grey;
      border-radius: 15px;
      display: inline-block;
      font-size: 1.2rem;
      line-height: 1.5;
      text-align: center;
      text-decoration: none;
      vertical-align: middle;
      cursor: pointer;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
      background-color: transparent;
      border: 1px solid transparent;
      padding: 0.375rem 0.75rem;
      transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
      color: #fff;
      background-color: #212529;
      border-color: #212529;
    }
    .btndarkCustom {
      color: #fff;
      background-color: #212529;
      border-color: #212529;
    }
    .btnCustom {
      display: inline-block;
      font-weight: 400;
      line-height: 1.5;
      color: #212529;
      text-align: center;
      text-decoration: none;
      vertical-align: middle;
      cursor: pointer;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
      background-color: white;
      border: 1px;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      border-radius: 15px;
      transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    }
    .progress-barCustom {
      display: flex;
      flex-direction: column;
      justify-content: center;
      overflow: hidden;
      color: rgb(0, 0, 0);
      text-align: center;
      white-space: nowrap;
      background-color: #000000;
      transition: width .6s ease;
    }
    /* Chrome slider styles */
    @media screen and (-webkit-min-device-pixel-ratio:0.3) {
      input[type='range'] {
        overflow: hidden;
        width: 150px;
        appearance: none;
        -webkit-appearance: none;
        background-color: #eeecef;
        border-radius: 10px;
      }
      input[type='range']::-webkit-slider-runnable-track {
        height: 20px;
        -webkit-appearance: none;
        color: #282828;
        margin-top: 0px;
        border-radius: 10px;
      }
      input[type='range']::-webkit-slider-thumb {
        width: 20px;
        -webkit-appearance: none;
        height: 20px;
        cursor: ew-resize;
        background: #8876FE;
        box-shadow: -80px 0 0 72px #282828;
        border-radius: 10px;
      }
    }
    /* FF slider styles */
    input[type="range"]::-moz-range-progress {
      background-color: #000000;
    }
    input[type="range"]::-moz-range-track {
      background-color: #9a905d;
    }
    /* IE slider styles */
    input[type="range"]::-ms-fill-lower {
      background-color: #000000;
    }
    input[type="range"]::-ms-fill-upper {
      background-color: #9a905d;
    }
    .iconClass {
      width: 100%;
    }
  </style>

  <!-- Additional styles for video container, graph and logs, plus toggle panel -->
  <style>
    /* Toggle Panel styling (vertical, circles, animated) */
    #togglePanel {
      position: fixed;
      top: 60px; /* just below the fixed header */
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1100;
    }
    .toggle-btn {
      background: rgba(0, 0, 0, 0.4);
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 15px;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, transform 0.3s;
      /* Floating animation */
      animation: float 3s ease-in-out infinite;
    }
    .toggle-btn:hover {
      transform: translateY(-5px) scale(1.1);
      color: rgba(255, 255, 0, 0.753); 
    }
    .toggle-btn.active {
      /* background-color: rgba(241, 196, 15, 0.4); */
      color: rgba(255, 255, 0, 0.753); 
    }
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0px); }
    }

    /* Video container styling */
    #videoContainer {
      /* Removed default green border */
      padding: 5px;
      display: none;
      border-radius: 35px;
      max-width: 500px;
      max-height: 500px;
      margin: auto;
    }
    /* New class to apply green border only after webcam feed is loaded */
    .loaded-border {
      border: 3px solid #00ff00;
    }
    /* Graph container styling */
    #graphContainer {
      margin: 20px auto;
      width: 800px;
      height: 400px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    /* Graph Heading styling */
    #graphContainer h3 {
      text-align: center;
      color: #f1c40f;
      margin-bottom: 10px;
      font-family: 'Poppins', sans-serif;
      border-bottom: 1px solid #f1c40f;
      padding-bottom: 5px;
    }
    /* Divider styling */
    .separator {
      width: 50%;
      height: 3px;
      background: linear-gradient(to right, transparent, #f1c40f, transparent);
      margin: 30px auto 10px;
      border-radius: 3px;
    }
    /* Graph Section */
    #graphSection {
      display: none;
      margin-bottom: 80px;
    }
    /* Logs Section Separator */
    #logsSeparator {
      width: 50%;
      height: 3px;
      background: linear-gradient(to right, transparent, #f1c40f, transparent);
      margin: 30px auto 10px;
      border-radius: 3px;
      display: none;
    }
    /* Logs Section styling */
    #logsSection {
      width: 800px;
      margin: 10px auto;
      border: 1px solid #ccc;
      border-radius: 15px;
      padding: 10px;
      background-color: #f8f9fa;
      display: none;
    }
    #logsSection h3 {
      text-align: center;
      color: #f1c40f;
      margin-bottom: 10px;
      font-family: 'Poppins', sans-serif;
      border-bottom: 1px solid #f1c40f;
      padding-bottom: 5px;
    }
    /* Logs header row styling */
    #logsHeader {
      display: flex;
      justify-content: space-between;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      text-align: center;
      color: #fff;
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 5px;
    }
    /* Column header styling with colored badges */
    .colHeader {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
      margin: 0 2px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .colFrame { background-color: #ff4d4d; }
    .colID { background-color: #4dff4d; }
    .colX { background-color: #4d4dff; }
    .colY { background-color: #bf40bf; }
    .colWidth { background-color: #ff944d; }
    .colHeight { background-color: #40e0d0; }
    /* Logs content styling */
    #trackerLogsContent {
      overflow-y: scroll;
      max-height: 300px;
      white-space: nowrap;
      font-family: monospace;
      padding: 5px;
      border-top: 1px solid #ccc;
    }
    .logRow {
      display: flex;
      justify-content: space-between;
      padding: 2px 5px;
      font-size: 0.9rem;
      border-bottom: 1px solid #eee;
    }
    .logCell {
      flex: 1;
      text-align: center;
    }
  </style>

  <script>
    let chart = null;
    let isWebcamActive = false;

    // This function adds the green border only after the webcam feed is properly loaded
    function onVideoLoad() {
      document.getElementById('videoContainer').classList.add('loaded-border');
      document.getElementById('videoContainer').style.display = 'block';
    }

    $(document).ready(function(){
      // Toggle Webcam Mode button
      $('#webcamToggle').click(function() {
        if (isWebcamActive) {
          // Reset video container and stats
          $('#videoFeed').attr('src', '');
          $('#videoContainer').hide().removeClass('loaded-border');
          $('#detectCount').text("0");
          $('#safecount').text("0");
          isWebcamActive = false;
          $(this).removeClass('active');
        } else {
          $('#videoFeed').attr('src', '/webcam_feed');
          // The video container will be shown with border after the image loads (via onVideoLoad)
          isWebcamActive = true;
          $(this).addClass('active');
        }
      });

      // Toggle Detection Graph button
      $('#graphToggle').click(function() {
        $('#graphSection').toggle();
        if($('#graphSection').is(':visible') && chart === null) {
          initializeChart();
        }
        $(this).toggleClass('active');
      });

      // Toggle Tracking Logs button
      $('#logsToggle').click(function() {
        $('#logsSeparator').toggle();
        $('#logsSection').toggle();
        $(this).toggleClass('active');
      });
    });

    function initializeChart() {
      const ctx = document.getElementById('detectionChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Total Detections',
            data: [],
            borderColor: 'rgb(255, 99, 132)',
            tension: 0.1,
            fill: false
          },
          {
            label: 'Safe Persons',
            data: [],
            borderColor: 'rgb(54, 162, 235)',
            tension: 0.1,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true },
            x: {
              ticks: {
                callback: function(value) {
                  return value;
                }
              }
            }
          }
        }
      });

      setInterval(() => {
        $.getJSON('/graphData', function(data) {
          if(chart.data.labels.length >= 30) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
          }
          chart.data.labels.push(new Date().toLocaleTimeString());
          chart.data.datasets[0].data.push(data.total);
          chart.data.datasets[1].data.push(data.safe);
          chart.update();
        });
      }, 1000);
    }

    function updateLogs() {
      $.get($SCRIPT_ROOT + '/tracker_logs', function(data) {
        let lines = data.split("\n").filter(l => l.trim() !== "");
        let html = "";
        lines.forEach(function(line) {
          let cols = line.split(",");
          html += "<div class='logRow'>";
          html += "<div class='logCell'>" + (cols[0] ? cols[0].trim() : "") + "</div>";
          html += "<div class='logCell'>" + (cols[1] ? cols[1].trim() : "") + "</div>";
          html += "<div class='logCell'>" + (cols[2] ? cols[2].trim() : "") + "</div>";
          html += "<div class='logCell'>" + (cols[3] ? cols[3].trim() : "") + "</div>";
          html += "<div class='logCell'>" + (cols[4] ? cols[4].trim() : "") + "</div>";
          html += "<div class='logCell'>" + (cols[5] ? cols[5].trim() : "") + "</div>";
          html += "</div>";
        });
        $('#trackerLogsContent').html(html);
        let tracker = document.getElementById('trackerLogsContent');
        tracker.scrollTop = tracker.scrollHeight;
      });
    }
    setInterval(updateLogs, 1000);
  </script>
</head>

<body data-script-root="{{ request.script_root|tojson|safe }}">
  <script>
    var $SCRIPT_ROOT = document.body.dataset.scriptRoot;
  </script>

  <!-- Fixed Custom Header -->
  <header class="custom-header">
    <i class="fas fa-shield-alt header-logo"></i>
    <div class="header-text">
      <h1>Safety Compliance Detection System</h1>
      <p>Computer Vision | AI | Machine Learning</p>
    </div>
  </header>

  <!-- Always-visible Vertical Toggle Panel with Floating Circles -->
  <div id="togglePanel">
    <button id="webcamToggle" class="toggle-btn"><i class="fas fa-video"></i></button>
    <button id="graphToggle" class="toggle-btn"><i class="fas fa-chart-line"></i></button>
    <button id="logsToggle" class="toggle-btn"><i class="fas fa-clipboard-list"></i></button>
  </div>

  <!-- Main Content -->
  <div class="container main-content" style="font-family: 'SF Pro Display', sans-serif; margin-bottom: 30px;">
    <div class="row">
      <div class="col-sm" style="border: 5px;">
        <div>
          <h2 style="font-weight: 900;">PPE Detection</h2>
        </div>
        <div id="videoContainer">
          <!-- The onload now calls onVideoLoad() -->
          <img id="videoFeed" src="{{ url_for('video') }}"
               style="width: auto; height: auto; border-radius: 35px; max-width: 500px; max-height: 500px; object-fit: contain;"
               onload="onVideoLoad()"
               onerror="this.onerror=null; this.src='../static/files/Black.png'" alt="Upload video">
        </div>
      </div>
      <div class="col-sm">
        <div class="flex-column">
          <div style="margin-top: 60px;">
            <div class="btn btn-dark" style="width: 100px; border-radius: 15px;">
              <div style="font-weight: 900; font-size: x-large; line-height: 1.5;">
                <span id="detectCount">0</span>
              </div>
              <div style="font-weight: bold;">Persons</div>
            </div>
            <b style="font-size: 1.2rem; line-height: 1.5;"> Persons Detected</b>
          </div>
          <div style="margin-top: 10px;">
            <div class="btn btn-dark" style="width: 100px; border-radius: 15px;">
              <div style="font-weight: 900; font-size: x-large; line-height: 1.5;">
                <span id="safecount">0</span>
              </div>
              <div style="font-weight: bold;">Persons</div>
            </div>
            <b style="font-size: 1.2rem; line-height: 1.5;"> Safe Persons</b>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-5 align-middle" style="text-align: center;">
      <form method="POST" enctype="multipart/form-data" style="align-content: center; text-align: center; display: flex;">
        {{form.hidden_tag()}}
        {{form.file(class_="custom-file-input")}}
        <div style="margin-top: 6px;">
          <b style="font-size: 1.2rem; line-height: 1.5; margin-top: 8px;">{{form.conf_slide.label}}</b>
          {{ form.conf_slide(min=0, max=100, oninput="outputUpdate(value)") }}
        </div>
        <div style="width:50px; margin-top: 5px;">
          <output for="conf_slide" id="selected-age">{{form.conf_slide.data}}</output>
        </div>
        <div style="margin-top: -8px;">
          <button type="submit" name="favorite" value="x" class="btnCustom" style="width: 100px;">
            <a href="https://www.freepnglogos.com/pics/play-button" title="Play Video">
              <img src="https://www.freepnglogos.com/uploads/play-button-png/youtube-style-play-button-clip-art-clkerm-vector-clip-art-online-royalty-31.png"
                   width="55" style="border-radius: 15px;" alt="Play Video" />
            </a>
          </button>
        </div>
      </form>
    </div>
    
    <!-- Graph Section -->
    <div id="graphSection">
      <div class="separator"></div>
      <div id="graphContainer">
        <h3>Detection Statistics</h3>
        <canvas id="detectionChart"></canvas>
      </div>
    </div>
    
    <!-- Logs Section Separator -->
    <div id="logsSeparator"></div>
    <!-- Logs Section -->
    <div id="logsSection">
      <h3>Tracking Logs</h3>
      <div id="logsHeader">
        <div class="colHeader colFrame">Frame</div>
        <div class="colHeader colID">ID</div>
        <div class="colHeader colX">X</div>
        <div class="colHeader colY">Y</div>
        <div class="colHeader colWidth">Width</div>
        <div class="colHeader colHeight">Height</div>
      </div>
      <div id="trackerLogsContent">
        <!-- Tracking logs will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <script>
    function outputUpdate(MyField) {
      document.querySelector('#selected-age').value = MyField;
    }
  </script>

  <script type="text/javascript">
    setInterval(function update_values() {
      $.getJSON($SCRIPT_ROOT + '/detectionCount', function(data) {
        $('#detectCount').text(data.detectCount);
      });
    }, 1000);
  </script>
  <script type="text/javascript">
    setInterval(function update_values() {
      $.getJSON($SCRIPT_ROOT + '/safeCount', function(data) {
        $('#safecount').text(data.safecount);
      });
    }, 1000);
  </script>
</body>

</html>
